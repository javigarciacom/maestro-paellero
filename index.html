
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro Paellero</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Lobster&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            background-color: #f4f1de; /* Creamy background */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed from center to flex-start */
            min-height: 100vh;
            padding: 20px; /* Added padding */
            box-sizing: border-box;
        }

        #game-container {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 20px;
            width: 100%;
            max-width: 900px; /* Max width for larger screens */
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: calc(100vh - 40px); /* Considering body padding */
            overflow-y: auto; /* Allow game-container to scroll */
        }

        #game-header {
            text-align: center;
            border-bottom: 2px solid #ffc107; /* Saffron color */
            padding-bottom: 10px;
            position: sticky; /* Make header sticky */
            top: 0;
            background-color: #fff; /* Add background to prevent content overlap on scroll */
            z-index: 50; /* Ensure header is above other content within game-container */
        }

        #game-header h1 {
            font-family: 'Lobster', cursive;
            color: #d35400; /* Paella pan color */
            font-size: 2.5em;
            margin: 0 0 10px 0;
        }

        #timers {
            display: flex;
            justify-content: space-around;
            font-size: 0.9em;
            font-weight: bold;
            color: #555;
        }

        #game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #paella-pan-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 auto; /* Center the paella pan */
        }

        #paella-pan {
            width: 200px;
            height: 200px;
            background-color: #bdc3c7; /* Pan color */
            border: 10px solid #d35400; /* Paella pan border */
            border-radius: 50%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Ingredients shouldn't spill out visually */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }

        #pan-ingredients-visual {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 10px;
        }

        .ingredient-in-pan {
            font-size: 1.5em; /* Emoji size */
            animation: fadeIn 0.5s ease-in-out;
            transition: filter 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .ingredient-in-pan.raw {
            opacity: 0.6; /* More transparent when raw */
        }
        .ingredient-in-pan.cooking {
            opacity: 0.8; 
        }
        .ingredient-in-pan.perfect {
            opacity: 1;
        }
        .ingredient-in-pan.overcooked {
            filter: saturate(1.2) brightness(0.85); /* Slightly more intense, bit darker */
        }
        .ingredient-in-pan.burnt {
            filter: grayscale(60%) brightness(0.5); /* Darker and desaturated */
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        #paella-lid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(100, 100, 100, 0.8); /* Semi-transparent lid */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            backdrop-filter: blur(2px);
            z-index: 10;
        }
        #paella-lid.hidden {
            display: none;
        }

        #fire-visual-container {
            margin-top: 10px;
            text-align: center;
        }

        #fire-level-display {
            font-weight: bold;
            color: #e67e22; /* Flame color */
            margin-bottom: 5px;
        }

        #fire-animation {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 30px; /* Adjust height of fire */
        }

        .flame {
            width: 10px;
            height: 100%; /* Default to full height, JS will adjust */
            background-color: #f39c12; /* Orange flame */
            border-radius: 5px 5px 0 0;
            margin: 0 2px;
            animation: flameDance 0.5s infinite alternate;
            opacity: 0; /* Initially hidden, JS will show based on fire level */
            transition: height 0.3s ease, opacity 0.3s ease;
        }

        .flame:nth-child(2) {
            animation-delay: 0.2s;
        }

        @keyframes flameDance {
            0% { transform: translateY(0) scaleY(1); }
            100% { transform: translateY(-5px) scaleY(1.1); }
        }


        #ingredients-panel {
            background-color: #fff9e6; /* Light yellow */
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffeb99;
        }

        #ingredients-panel h2, #controls-panel h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 10px;
            color: #c0392b; /* Dark red */
            font-size: 1.3em;
        }

        #ingredients-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .ingredient-button {
            background-color: #ffc107; /* Saffron */
            color: #333;
            border: 1px solid #e0a800;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9em;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s, transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .ingredient-button:hover:not(:disabled) {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        .ingredient-button:disabled {
            background-color: #ccc;
            color: #777;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .ingredient-icon {
            font-size: 1.5em;
        }

        #controls-panel {
            background-color: #e6fff0; /* Light green */
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #b3ffcc;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: bold;
        }

        #fire-slider {
            flex-grow: 1;
            cursor: pointer;
        }

        #controls-panel button {
            background-color: #3498db; /* Blue */
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #controls-panel button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        #controls-panel button:disabled {
            background-color: #a9cce3; /* Lighter blue when disabled */
            cursor: not-allowed;
        }


        #serve-button {
            background-color: #2ecc71; /* Green */
        }
        #serve-button:hover:not(:disabled) {
            background-color: #27ae60;
        }


        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000; /* Ensure modals are on top of everything */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h2 {
            font-family: 'Lobster', cursive;
            color: #d35400;
            margin-top: 0;
        }

        .modal-content button {
            background-color: #ff7f50; /* Coral */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.2s;
        }

        .modal-content button:hover {
            background-color: #ff6347; /* Tomato red */
        }


        /* Responsive Design */
        @media (min-width: 768px) {
            #game-area {
                flex-direction: row;
                align-items: flex-start; /* Align items to the top */
            }

            #paella-pan-container {
                flex-basis: 45%; /* Paella pan takes up space */
                margin: 0;
                position: sticky; /* Sticky pan on larger screens */
                top: 80px; /* Adjust based on header height */
            }
             #paella-pan {
                width: 280px;
                height: 280px;
            }
            .ingredient-in-pan {
                font-size: 2em;
            }

            #ingredients-panel {
                flex-basis: 55%; /* Ingredients panel takes up remaining space */
                max-height: 450px; 
                overflow-y: auto; 
            }
            
            #controls-panel {
                margin-top: 0; 
            }
        }

        /* Smaller devices */
        @media (max-width: 480px) {
            #game-header h1 {
                font-size: 2em;
            }
            #timers {
                font-size: 0.8em;
                flex-direction: column;
                gap: 5px;
            }
             #paella-pan {
                width: 180px;
                height: 180px;
            }
            .ingredient-in-pan {
                font-size: 1.3em;
            }
            .ingredient-button {
                font-size: 0.8em;
                padding: 8px;
            }
            .ingredient-icon {
                font-size: 1.3em;
            }
            #controls-panel button {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            .modal-content {
                padding: 20px;
            }
             #game-header {
                padding-bottom: 5px; /* Reduce padding for smaller screens */
            }
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="game-container">
        <header id="game-header">
            <h1>Maestro Paellero</h1>
            <div id="timers">
                <div id="real-time-timer">Tiempo Real: 03:00</div>
                <div id="simulated-time-timer">Tiempo CocciÃ³n: 00:00 / 60:00</div>
            </div>
        </header>

        <main id="game-area">
            <div id="paella-pan-container">
                <div id="paella-pan">
                    <div id="paella-lid" class="hidden"></div>
                    <div id="pan-ingredients-visual"></div>
                </div>
                <div id="fire-visual-container">
                    <div id="fire-level-display">Fuego: 5</div>
                    <div id="fire-animation">
                        <div class="flame"></div>
                        <div class="flame"></div>
                        <div class="flame"></div>
                    </div>
                </div>
            </div>

            <aside id="ingredients-panel">
                <h2>Ingredientes</h2>
                <div id="ingredients-list">
                    <!-- Ingredients will be populated by JS -->
                </div>
            </aside>
        </main>
        
        <footer id="controls-panel">
            <h2>Controles</h2>
            <div class="control-group">
                <label for="fire-slider">Fuego:</label>
                <input type="range" id="fire-slider" min="0" max="10" value="5" aria-label="Control de Fuego">
                <span id="fire-value-display">5</span>
            </div>
            <button id="stir-button" aria-label="Remover">Remover</button>
            <button id="cover-button" aria-label="Tapar">Tapar</button>
            <button id="serve-button" aria-label="Servir">Servir</button>
        </footer>

        <div id="start-modal" class="modal visible">
            <div class="modal-content">
                <h2>Â¡Bienvenido a Maestro Paellero!</h2>
                <p>Demuestra tus habilidades cocinando la paella perfecta en 3 minutos (1 hora de tiempo simulado).</p>
                <p>AÃ±ade los ingredientes, controla el fuego y sirve cuando estÃ© lista. Â¡Suerte!</p>
                <button id="start-game-button">Â¡A Cocinar!</button>
            </div>
        </div>

        <div id="end-modal" class="modal">
            <div class="modal-content">
                <h2 id="end-title">Â¡Paella Servida!</h2>
                <p id="score-display">PuntuaciÃ³n: 0/100</p>
                <p id="feedback-message">ValoraciÃ³n del chef...</p>
                <button id="play-again-button">Jugar de Nuevo</button>
            </div>
        </div>

    </div>
    <script type="module">
        // --- Constants ---
        const REAL_GAME_DURATION_SECONDS = 180; // 3 minutes
        const SIMULATED_GAME_DURATION_MINUTES = 60; // 1 hour
        const TIME_COMPRESSION_FACTOR = (SIMULATED_GAME_DURATION_MINUTES * 60) / REAL_GAME_DURATION_SECONDS;

        const ALL_INGREDIENTS_BASE = [
            // Times are in simulated game seconds. Durations are for time IN PAN.
            { id: 'oil', name: 'Aceite', icon: 'ðŸ’§', correctSimTimeStart: 0, correctSimTimeEnd: 120, minCookTimeInPanSim: 1, idealCookTimeInPanEndSim: 3600, overcookTimeInPanEndSim: 3600, pointsForAddingOnTime: 2, penaltyForAddingWrongTime: 1, penaltyForMissing: 5, pointsForPerfectCook: 1, penaltyForRaw: 0, penaltyForOvercooked: 0, penaltyForBurnt: 1, essential: true },
            { id: 'chicken', name: 'Pollo', icon: 'ðŸ—', correctSimTimeStart: 60, correctSimTimeEnd: 300, minCookTimeInPanSim: 600, idealCookTimeInPanEndSim: 1200, overcookTimeInPanEndSim: 1500, pointsForAddingOnTime: 5, penaltyForAddingWrongTime: 3, penaltyForMissing: 10, pointsForPerfectCook: 5, penaltyForRaw: 8, penaltyForOvercooked: 4, penaltyForBurnt: 10, essential: true }, // Sofrito: 10-20 min cook, overcooked after 25 min
            { id: 'rabbit', name: 'Conejo', icon: 'ðŸ‡', correctSimTimeStart: 60, correctSimTimeEnd: 300, minCookTimeInPanSim: 600, idealCookTimeInPanEndSim: 1200, overcookTimeInPanEndSim: 1500, pointsForAddingOnTime: 5, penaltyForAddingWrongTime: 3, penaltyForMissing: 10, pointsForPerfectCook: 5, penaltyForRaw: 8, penaltyForOvercooked: 4, penaltyForBurnt: 10, essential: true },
            { id: 'greenBeans', name: 'JudÃ­as V.', icon: 'ðŸŒ¿', correctSimTimeStart: 300, correctSimTimeEnd: 600, minCookTimeInPanSim: 300, idealCookTimeInPanEndSim: 720, overcookTimeInPanEndSim: 900, pointsForAddingOnTime: 3, penaltyForAddingWrongTime: 2, penaltyForMissing: 5, pointsForPerfectCook: 3, penaltyForRaw: 4, penaltyForOvercooked: 2, penaltyForBurnt: 5, essential: true }, // Sofrito: 5-12 min cook
            { id: 'garrofo', name: 'GarrofÃ³', icon: 'ðŸ«˜', correctSimTimeStart: 300, correctSimTimeEnd: 600, minCookTimeInPanSim: 300, idealCookTimeInPanEndSim: 720, overcookTimeInPanEndSim: 900, pointsForAddingOnTime: 3, penaltyForAddingWrongTime: 2, penaltyForMissing: 5, pointsForPerfectCook: 3, penaltyForRaw: 4, penaltyForOvercooked: 2, penaltyForBurnt: 5, essential: true },
            { id: 'tomato', name: 'Tomate', icon: 'ðŸ…', correctSimTimeStart: 480, correctSimTimeEnd: 720, minCookTimeInPanSim: 180, idealCookTimeInPanEndSim: 480, overcookTimeInPanEndSim: 600, pointsForAddingOnTime: 4, penaltyForAddingWrongTime: 2, penaltyForMissing: 5, pointsForPerfectCook: 3, penaltyForRaw: 3, penaltyForOvercooked: 2, penaltyForBurnt: 5, essential: true }, // Sofrito: 3-8 min cook
            { id: 'paprika', name: 'PimentÃ³n', icon: 'ðŸŒ¶ï¸', correctSimTimeStart: 600, correctSimTimeEnd: 780, minCookTimeInPanSim: 10, idealCookTimeInPanEndSim: 30, overcookTimeInPanEndSim: 45, pointsForAddingOnTime: 3, penaltyForAddingWrongTime: 2, penaltyForMissing: 4, pointsForPerfectCook: 2, penaltyForRaw: 1, penaltyForOvercooked: 4, penaltyForBurnt: 8, essential: true }, // Critical: 10-30s, burns fast
            { id: 'water', name: 'Agua', icon: 'ðŸš°', correctSimTimeStart: 720, correctSimTimeEnd: 1020, minCookTimeInPanSim: 1, idealCookTimeInPanEndSim: 3600, overcookTimeInPanEndSim: 3600, pointsForAddingOnTime: 3, penaltyForAddingWrongTime: 2, penaltyForMissing: 8, pointsForPerfectCook: 0, penaltyForRaw: 0, penaltyForOvercooked: 0, penaltyForBurnt: 0, essential: true },
            { id: 'saffron', name: 'AzafrÃ¡n', icon: 'âœ¨', correctSimTimeStart: 720, correctSimTimeEnd: 1020, minCookTimeInPanSim: 1, idealCookTimeInPanEndSim: 3600, overcookTimeInPanEndSim: 3600, pointsForAddingOnTime: 4, penaltyForAddingWrongTime: 2, penaltyForMissing: 4, pointsForPerfectCook: 1, penaltyForRaw: 0, penaltyForOvercooked: 0, penaltyForBurnt: 0, essential: true },
            { id: 'salt', name: 'Sal', icon: 'ðŸ§‚', correctSimTimeStart: 0, correctSimTimeEnd: 1500, minCookTimeInPanSim: 1, idealCookTimeInPanEndSim: 3600, overcookTimeInPanEndSim: 3600, pointsForAddingOnTime: 1, penaltyForAddingWrongTime: 1, penaltyForMissing: 2, pointsForPerfectCook: 0, penaltyForRaw: 0, penaltyForOvercooked: 0, penaltyForBurnt: 0, essential: true },
            { id: 'rice', name: 'Arroz', icon: 'ðŸš', correctSimTimeStart: 1500, correctSimTimeEnd: 1800, minCookTimeInPanSim: 900, idealCookTimeInPanEndSim: 1200, overcookTimeInPanEndSim: 1380, pointsForAddingOnTime: 10, penaltyForAddingWrongTime: 8, penaltyForMissing: 20, pointsForPerfectCook: 10, penaltyForRaw: 15, penaltyForOvercooked: 8, penaltyForBurnt: 20, essential: true }, // Cooks 15-20 min, overcooked 23 min, burnt after
            { id: 'rosemary', name: 'Romero', icon: 'ðŸŒ±', correctSimTimeStart: 2700, correctSimTimeEnd: 3300, minCookTimeInPanSim: 60, idealCookTimeInPanEndSim: 300, overcookTimeInPanEndSim: 480, pointsForAddingOnTime: 1, penaltyForAddingWrongTime: 1, penaltyForMissing: 0, pointsForPerfectCook: 1, penaltyForRaw: 0, penaltyForOvercooked: 1, penaltyForBurnt: 2, essential: false }, // Added near end for ~5 min
        ];


        // --- State Variables ---
        let gameState = "pre-start";
        let realTimeRemainingSeconds = REAL_GAME_DURATION_SECONDS;
        let simulatedTimeElapsedSeconds = 0;
        let fireLevel = 5;
        let isPaellaCovered = false;
        let ingredients = [];
        let stirCountAfterRice = 0;
        let riceAddedSimTime = null;
        let score = 0;
        let detailedFeedback = [];
        let gameIntervalId = null;

        // --- DOM Elements ---
        const realTimeTimerEl = document.getElementById('real-time-timer');
        const simulatedTimeTimerEl = document.getElementById('simulated-time-timer');
        const ingredientsListEl = document.getElementById('ingredients-list');
        const paellaPanVisualEl = document.getElementById('pan-ingredients-visual');
        const paellaLidEl = document.getElementById('paella-lid');
        const fireSliderEl = document.getElementById('fire-slider');
        const fireValueDisplayEl = document.getElementById('fire-value-display');
        const fireLevelDisplayEl = document.getElementById('fire-level-display');
        const fireFlames = document.querySelectorAll('#fire-animation .flame');
        const stirButtonEl = document.getElementById('stir-button');
        const coverButtonEl = document.getElementById('cover-button');
        const serveButtonEl = document.getElementById('serve-button');
        const startModalEl = document.getElementById('start-modal');
        const endModalEl = document.getElementById('end-modal');
        const startGameButtonEl = document.getElementById('start-game-button');
        const playAgainButtonEl = document.getElementById('play-again-button');
        const scoreDisplayEl = document.getElementById('score-display');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const endTitleEl = document.getElementById('end-title');

        // --- Helper Functions ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function resetIngredientsState() {
            return ALL_INGREDIENTS_BASE.map(base => ({
                ...base,
                addedToPan: false,
                simTimeAdded: null,
                cookState: 'notAdded',
            }));
        }

        // --- Game Logic Functions ---
        function startGame() {
            gameState = "playing";
            realTimeRemainingSeconds = REAL_GAME_DURATION_SECONDS;
            simulatedTimeElapsedSeconds = 0;
            fireLevel = 5;
            isPaellaCovered = false;
            ingredients = resetIngredientsState();
            stirCountAfterRice = 0;
            riceAddedSimTime = null;
            score = 0;
            detailedFeedback = [];

            startModalEl.classList.remove('visible');
            endModalEl.classList.remove('visible');
            
            updateIngredientsPanel();
            updatePaellaVisual();
            updateControls();
            updateTimers();
            updateFireVisual();

            gameIntervalId = setInterval(updateGame, 1000);
        }

        function updateGame() {
            if (gameState !== "playing") return;

            realTimeRemainingSeconds--;
            simulatedTimeElapsedSeconds += TIME_COMPRESSION_FACTOR;

            let visualUpdateNeeded = false;
            ingredients.filter(ing => ing.addedToPan && ing.simTimeAdded !== null).forEach(ing => {
                const timeInPan = simulatedTimeElapsedSeconds - ing.simTimeAdded;
                const oldCookState = ing.cookState;

                if (timeInPan > ing.overcookTimeInPanEndSim) {
                    ing.cookState = 'burnt';
                } else if (timeInPan > ing.idealCookTimeInPanEndSim) {
                    ing.cookState = 'overcooked';
                } else if (timeInPan > ing.minCookTimeInPanSim) {
                    ing.cookState = 'perfect';
                } else if (timeInPan > 0) { 
                     ing.cookState = 'cooking'; 
                } else { 
                    ing.cookState = 'raw';
                }
                
                if(ing.id === 'oil' && timeInPan > 0) ing.cookState = 'perfect';

                if (oldCookState !== ing.cookState) {
                    visualUpdateNeeded = true;
                }
            });

            if (visualUpdateNeeded) {
                updatePaellaVisual();
            }
            updateTimers();

            if (realTimeRemainingSeconds <= 0) {
                endGame(false); 
            }
        }

        function addIngredientToPaella(ingredientId) {
            if (gameState !== "playing") return;

            const ingredient = ingredients.find(ing => ing.id === ingredientId);
            if (ingredient && !ingredient.addedToPan) {
                ingredient.addedToPan = true;
                ingredient.simTimeAdded = simulatedTimeElapsedSeconds;
                ingredient.cookState = 'raw'; 
                if (ingredient.id === 'rice') {
                    riceAddedSimTime = simulatedTimeElapsedSeconds;
                }
                updateIngredientsPanel();
                updatePaellaVisual();
            }
        }

        function handleFireChange(newLevel) {
            if (gameState !== "playing") return;
            fireLevel = newLevel;
            updateFireVisual(); 
        }

        function updateFireVisual() {
            const baseFlameHeight = 20; 
            fireFlames.forEach((flame, index) => {
                const activeFlames = Math.ceil(fireLevel / (10 / fireFlames.length));
                if (index < activeFlames ) {
                    flame.style.opacity = '1';
                    const heightPercentage = Math.min(1, (fireLevel / 10) * (1 + (index * 0.1)));
                    flame.style.height = `${baseFlameHeight * heightPercentage * (0.8 + Math.random() * 0.4)}px`;
                } else {
                    flame.style.opacity = '0';
                    flame.style.height = '0px';
                }
            });
            fireSliderEl.value = String(fireLevel);
            fireValueDisplayEl.textContent = String(fireLevel);
            fireLevelDisplayEl.textContent = `Fuego: ${fireLevel}`;
        }


        function handleStirIngredients() {
            if (gameState !== "playing") return;
            if (riceAddedSimTime !== null && simulatedTimeElapsedSeconds > riceAddedSimTime) {
                stirCountAfterRice++;
            }
        }

        function handleCoverToggle() {
            if (gameState !== "playing") return;
            isPaellaCovered = !isPaellaCovered;
            coverButtonEl.textContent = isPaellaCovered ? "Destapar Paella" : "Tapar Paella";
            if (isPaellaCovered) {
                paellaLidEl.classList.remove('hidden');
                paellaLidEl.textContent = 'TAPADA';
            } else {
                paellaLidEl.classList.add('hidden');
            }
        }

        function servePaella() {
            if (gameState !== "playing") return;
            endGame(true); 
        }

        function calculateScore(servedByUser) {
            let currentScore = 50; 
            detailedFeedback = [];

            ingredients.forEach(ing => {
                if (ing.addedToPan && ing.simTimeAdded !== null) {
                    if (ing.simTimeAdded >= ing.correctSimTimeStart && ing.simTimeAdded <= ing.correctSimTimeEnd) {
                        currentScore += ing.pointsForAddingOnTime;
                    } else {
                        currentScore -= ing.penaltyForAddingWrongTime;
                        detailedFeedback.push(`El ${ing.name.toLowerCase()} se aÃ±adiÃ³ ${ing.simTimeAdded < ing.correctSimTimeStart ? 'DEMASIADO PRONTO' : 'DEMASIADO TARDE'}. Â¡El tempo es clave!`);
                    }

                    switch (ing.cookState) {
                        case 'perfect':
                            currentScore += ing.pointsForPerfectCook;
                            break;
                        case 'raw':
                            currentScore -= ing.penaltyForRaw;
                            if (ing.penaltyForRaw > 0) detailedFeedback.push(`El ${ing.name.toLowerCase()} quedÃ³ CRUDO. Â¿PretendÃ­as servirnos un tartar?`);
                            break;
                        case 'overcooked':
                            currentScore -= ing.penaltyForOvercooked;
                             if (ing.penaltyForOvercooked > 0) detailedFeedback.push(`El ${ing.name.toLowerCase()} se pasÃ³ de cocciÃ³n. Una pena, casi lo tenÃ­as.`);
                            break;
                        case 'burnt':
                            currentScore -= ing.penaltyForBurnt;
                            if (ing.penaltyForBurnt > 0) detailedFeedback.push(`Â¡SACRILEGIO! El ${ing.name.toLowerCase()} estÃ¡ QUEMADO. Esto es inaceptable.`);
                            break;
                    }
                } else if (ing.essential) {
                    currentScore -= ing.penaltyForMissing;
                    detailedFeedback.push(`FaltÃ³ ${ing.name.toLowerCase()}, un ingrediente ESENCIAL. Â¡Imperdonable olvido!`);
                }
            });

            const rice = ingredients.find(i => i.id === 'rice');
            if (rice?.addedToPan && rice.simTimeAdded !== null) {
                const riceCookTime = simulatedTimeElapsedSeconds - rice.simTimeAdded;
                if (riceCookTime > (rice.idealCookTimeInPanEndSim - 600) && rice.cookState !== 'burnt' && rice.cookState !== 'overcooked') {
                    if (fireLevel > 7) { 
                        currentScore -= 8;
                        detailedFeedback.push("El fuego INCINERANDO el arroz al final... Â¡Control, por favor!");
                    }
                    if (fireLevel < 3 && riceCookTime > rice.minCookTimeInPanSim + 300) { 
                        currentScore -= 8;
                        detailedFeedback.push("Fuego demasiado BAJO para el arroz. Â¿Esperabas un milagro?");
                    }
                }
            } else if (ingredients.find(i => i.id === 'water')?.addedToPan && !rice?.addedToPan) { 
                 currentScore -= 15;
                 detailedFeedback.push("Agua sin arroz... Has hecho un caldo caro, no una paella. Â¡QuÃ© desperdicio!");
            }


            if (stirCountAfterRice > 1) { 
                currentScore -= Math.min(15, stirCountAfterRice * 3); 
                detailedFeedback.push(`Removiste el arroz ${stirCountAfterRice} veces. Â¡El arroz NO SE TOCA una vez distribuido!`);
            }

            const riceCooked = rice?.cookState === 'perfect' || rice?.cookState === 'overcooked';
            if (riceCooked) {
                const simulatedRestTimeIdealStart = rice.simTimeAdded + rice.idealCookTimeInPanEndSim;
                if (isPaellaCovered && servedByUser && simulatedTimeElapsedSeconds >= simulatedRestTimeIdealStart && simulatedTimeElapsedSeconds <= simulatedRestTimeIdealStart + (10 * 60) ) {
                    currentScore += 5;
                } else if (!isPaellaCovered && servedByUser && simulatedTimeElapsedSeconds >= simulatedRestTimeIdealStart && simulatedTimeElapsedSeconds <= simulatedRestTimeIdealStart + (10*60)) {
                    currentScore -= 5;
                    detailedFeedback.push("La paella necesita REPOSAR TAPADA. Un detalle crucial que has ignorado.");
                }
            }


            if (servedByUser) {
                if (rice?.addedToPan && rice.cookState === 'raw') {
                    currentScore -= 15; 
                }
                if (simulatedTimeElapsedSeconds < SIMULATED_GAME_DURATION_MINUTES * 60 * 0.7 && rice?.addedToPan) { 
                     currentScore -= 5;
                     detailedFeedback.push("Serviste con prisas. La paciencia es una virtud del paellero.");
                }
            } else { 
                currentScore -= 10; 
                detailedFeedback.push("Â¡TIEMPO! No has servido. Una paella no entregada es una paella fallida.");
            }
            
            score = Math.max(0, Math.min(100, Math.round(currentScore)));
        }

        function generateMasterChefFeedback() {
            let mainMessage;
            let title;
            let feedbackIntro;

            if (score === 100) {
                title = "Â¡PERFECCIÃ“N DIVINA!";
                mainMessage = "No tengo palabras. Has trascendido la cocina para crear ARTE. Cada grano, cada sabor, es una sinfonÃ­a. Â¡ESTO es paella! Â¡BRAVO!";
                feedbackIntro = "Matices de un genio (si es que hay alguno):";
            } else if (score >= 95) {
                title = "Â¡OBRA MAESTRA INMINENTE!";
                mainMessage = "Has rozado la perfecciÃ³n con la punta de los dedos. Una paella que emociona, que habla, que casi levita. Un suspiro te separa de la gloria eterna. Â¡Impresionante!";
                feedbackIntro = "Detalles para la matrÃ­cula de honor:";
            } else if (score >= 90) {
                title = "Â¡TALENTO EXCEPCIONAL!";
                mainMessage = "AquÃ­ hay madera de campeÃ³n. TÃ©cnica depurada, instinto y una ejecuciÃ³n brillante. Esta paella tiene alma y demuestra un profundo respeto por el producto. Â¡Sigue asÃ­!";
                feedbackIntro = "Observaciones para pulir el diamante:";
            } else if (score >= 85) {
                title = "Â¡DESTACADO CON HONORES!";
                mainMessage = "Una paella muy notable, de esas que se recuerdan. Buen control, buen sabor, buena presentaciÃ³n. Demuestras oficio y pasiÃ³n. Â¡Muy bien!";
                feedbackIntro = "Apuntes para alcanzar la excelencia:";
            } else if (score >= 80) {
                title = "Â¡MUY PROMETEDOR, PERO...!";
                mainMessage = "Tienes la base, tienes la idea, pero te falta ese 'algo' que convierte lo bueno en extraordinario. Hay destellos, pero tambiÃ©n sombras. Â¡No te conformes!";
                feedbackIntro = "Ãreas de mejora para un futuro campeÃ³n:";
            } else if (score >= 70) {
                title = "APROBADO, CON PEROS EVIDENTES";
                mainMessage = "Tu paella es... correcta. Pasa el corte, pero sin alardes. Hay intenciÃ³n, pero la ejecuciÃ³n se queda a medio gas. Necesitas mÃ¡s rigor y ambiciÃ³n.";
                feedbackIntro = "Aspectos a revisar urgentemente:";
            } else if (score >= 60) {
                title = "MEDIOCRE. SIN ALMA NI RIESGO";
                mainMessage = "Me has dejado completamente frÃ­o. Esta paella no transmite nada. Es un ejercicio de mÃ­nimos, insÃ­pido y falto de carÃ¡cter. Â¡Despierta o dedÃ­cate a otra cosa!";
                feedbackIntro = "Defectos que no se pueden ignorar:";
            } else if (score >= 50) {
                title = "PREOCUPANTEMENTE DEFICIENTE";
                mainMessage = "Empezamos a tener un problema serio. Los errores son demasiado evidentes y afectan gravemente al resultado. Esto se aleja mucho de una paella aceptable.";
                feedbackIntro = "Errores de bulto que sentencian el plato:";
            } else if (score >= 40) {
                title = "UN AUTÃ‰NTICO DESPROPÃ“SITO";
                mainMessage = "Sinceramente, no sÃ© ni por dÃ³nde empezar. Esto es un cÃºmulo de desatinos. Has maltratado el producto y la tÃ©cnica. Â¡Necesitas volver a los fundamentos, YA!";
                feedbackIntro = "Desastres culinarios detectados:";
            } else if (score >= 30) {
                title = "Â¡OFENSA CULINARIA!";
                mainMessage = "Esto no es una paella, es un insulto a la tradiciÃ³n y al buen gusto. Cada bocado es una penitencia. Francamente, impresentable.";
                feedbackIntro = "Atrocidades cometidas en esta paella:";
            } else if (score >= 20) {
                title = "Â¡VERGÃœENZA AJENA!";
                mainMessage = "Dudo que esto se lo comiera ni el mÃ¡s hambriento. Es una sucesiÃ³n de errores catastrÃ³ficos. DeberÃ­as replantearte seriamente tu futuro en la cocina.";
                feedbackIntro = "Lista de horrores (no exhaustiva):";
            } else { // score < 20
                title = "Â¿ESTO ES UNA BROMA?";
                mainMessage = "No, en serio, Â¿pretendÃ­as que evaluara ESTO? Es un atentado gastronÃ³mico. Has conseguido lo imposible: hacer una anti-paella. RetÃ­rate.";
                feedbackIntro = "CrÃ³nica de un fracaso anunciado:";
            }

            if(detailedFeedback.length > 0) {
                mainMessage += `\n\n${feedbackIntro}\n- ` + detailedFeedback.slice(0,4).join("\n- "); 
            }

            feedbackMessageEl.textContent = mainMessage;
            endTitleEl.textContent = title;
        }


        function endGame(servedByUser) {
            if (gameState !== "playing") return;
            gameState = "finished";
            if (gameIntervalId) clearInterval(gameIntervalId);
            gameIntervalId = null;

            calculateScore(servedByUser);
            generateMasterChefFeedback();

            scoreDisplayEl.textContent = `PuntuaciÃ³n: ${score}/100`;
            endModalEl.classList.add('visible');
            
            stirButtonEl.disabled = true;
            coverButtonEl.disabled = true;
            serveButtonEl.disabled = true;
            fireSliderEl.disabled = true;
            ingredients.forEach(ing => {
                const btn = document.getElementById(`ing-${ing.id}`);
                if (btn) btn.disabled = true;
            });
        }


        // --- UI Update Functions ---
        function updateTimers() {
            realTimeTimerEl.textContent = `Tiempo Real: ${formatTime(realTimeRemainingSeconds)}`;
            simulatedTimeTimerEl.textContent = `Tiempo CocciÃ³n: ${formatTime(Math.floor(simulatedTimeElapsedSeconds))} / ${formatTime(SIMULATED_GAME_DURATION_MINUTES * 60)}`;
        }

        function updateIngredientsPanel() {
            ingredientsListEl.innerHTML = ''; 
            ingredients.forEach(ingredient => {
                const button = document.createElement('button');
                button.id = `ing-${ingredient.id}`;
                button.classList.add('ingredient-button');
                button.innerHTML = `<span class="ingredient-icon">${ingredient.icon}</span> ${ingredient.name}`;
                button.setAttribute('aria-label', `AÃ±adir ${ingredient.name}`);
                if (ingredient.addedToPan || gameState !== "playing") {
                    button.disabled = true;
                }
                button.onclick = () => addIngredientToPaella(ingredient.id);
                ingredientsListEl.appendChild(button);
            });
        }

        function updatePaellaVisual() {
            paellaPanVisualEl.innerHTML = '';
            ingredients.filter(ing => ing.addedToPan).forEach(ing => {
                const span = document.createElement('span');
                span.classList.add('ingredient-in-pan');
                if (ing.cookState !== 'notAdded') {
                     span.classList.add(ing.cookState);
                }
                span.textContent = ing.icon;
                span.setAttribute('aria-label', `${ing.name} (${ing.cookState})`);
                span.setAttribute('data-icon', ing.icon); 
                paellaPanVisualEl.appendChild(span);
            });
        }

        function updateControls() {
            fireSliderEl.value = String(fireLevel);
            fireValueDisplayEl.textContent = String(fireLevel);
            fireLevelDisplayEl.textContent = `Fuego: ${fireLevel}`;
            updateFireVisual();

            coverButtonEl.textContent = isPaellaCovered ? "Destapar Paella" : "Tapar Paella";
             if (isPaellaCovered) {
                paellaLidEl.classList.remove('hidden');
                paellaLidEl.textContent = 'TAPADA';
            } else {
                paellaLidEl.classList.add('hidden');
            }

            const isPlaying = gameState === "playing";
            stirButtonEl.disabled = !isPlaying;
            coverButtonEl.disabled = !isPlaying;
            serveButtonEl.disabled = !isPlaying;
            fireSliderEl.disabled = !isPlaying;
        }

        // --- Initialization ---
        function init() {
            startGameButtonEl.onclick = startGame;
            playAgainButtonEl.onclick = () => { 
                endModalEl.classList.remove('visible');
                startModalEl.classList.add('visible');
                gameState = "pre-start";
                ingredients = resetIngredientsState(); 
                updateIngredientsPanel(); 
                updatePaellaVisual(); 
                fireLevel = 5; 
                isPaellaCovered = false; 
                updateControls(); 
                fireSliderEl.disabled = true; 
                realTimeRemainingSeconds = REAL_GAME_DURATION_SECONDS; 
                simulatedTimeElapsedSeconds = 0;
                updateTimers();
            };
            
            fireSliderEl.oninput = (e) => {
                const newLevel = parseInt(e.target.value);
                fireValueDisplayEl.textContent = String(newLevel); 
                fireLevelDisplayEl.textContent = `Fuego: ${newLevel}`;
                if (gameState === "playing") { 
                    handleFireChange(newLevel);
                } else { 
                    fireLevel = newLevel;
                    updateFireVisual();
                }
            };
            stirButtonEl.onclick = handleStirIngredients;
            coverButtonEl.onclick = handleCoverToggle;
            serveButtonEl.onclick = servePaella;

            startModalEl.classList.add('visible');
            ingredients = resetIngredientsState(); 
            updateIngredientsPanel(); 
            updateControls(); 
            updateTimers(); 
            updateFireVisual(); 
            fireSliderEl.disabled = true; 
        }

        // Start the application
        init();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
